machine:
  services:
    - docker
dependencies:
  pre:
    - gem install package_cloud
  cache_directories:
    - "~/docker"
    - "~/packages"
  override:
    - docker info
    - if [[ -e ~/docker/image.tar ]]; then docker load --input ~/docker/image.tar; fi:
        timeout: 1200
    - docker build -t dynamike/mongo .
    - mkdir -p ~/docker; docker save dynamike/mongo > ~/docker/image.tar
    - sudo mkdir -p !packages
    - docker run -i -d dynamike/mongo; sleep 10
    - sudo docker cp $(docker ps | grep mongo | cut -d" " -f1):/debs ~/packages/ && chown -R ubuntu:ubuntu ~/packages

test:
  override:
    - DEBIAN_FRONTEND=noninteractive sudo apt-get -y remove mongodb-10gen
    - DEBIAN_FRONTEND=noninteractive sudo add-apt-repository -y ppa:ubuntu-toolchain-r/test
    - DEBIAN_FRONTEND=noninteractive sudo apt-get -y install libstdc++6
    - sudo dpkg -i ~/packages/debs/dst/x86_64/ubuntu/ubuntu1404/*.deb


deployment:
  production:
    branch: master
    commands:
      - package_cloud push dynamike/mongo/ubuntu/trusty ~/packages/debs/dst/x86_64/ubuntu/ubuntu1404/*.deb
